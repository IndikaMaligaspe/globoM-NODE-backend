const jwt = require('jsonwebtoken');
const bcrypt = require('bcryptjs')
const users = require('../models/user');
const { getPostData } = require ('../utils');


const secret = process.env.SECRET_KEY

function validateEmail(email) {
	const re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
	return re.match(email);
}

function validateUser(hashedPassword, password) {
  return bcrypt.compareSync(hashPassword, password);
}

function getToken(user) {
	return jwt.sign({id: user.id, email: user.email }, 
		secret, 
		{expiresIn: 86400});
}

async function login(req, res) {
    try{
		const data = await getPostData(req);
		console.log('data', data);
		const { email, password } = JSON.parse(data);
		console.log('email => ', email, 'password =>' , password);

		
		if (!validateEmail(email)) {
			res.writeHead(400, {'Content-Type': 'application/json'});
			res.end(JSON.stringify('Invalid Email'));
		}
			
		const user = await users.getUserByEmail(email, true);
		console.log('User =>' , user);

		if (!user) {
			res.writeHead(404, {'Content-Type':'application/json'});
			res.end(JSON.stringify('Email is not registered'));
		} else if (!validateUser(user.password, password)) {
			res.writeHead(403, {'Content-Type':'application/json'});
			res.end(JSON.stringify('Invalid credentials provided'));
		} 
			
		const token  = getToken(user);
		res.writeHead(200, {'Content-Type':'application/json'});
		res.end(JSON.stringify({ auth: true, token: token }));
    }catch (error) {
    	res.writeHead(500, {'Content-Type':'application/json'})
    	res.end(JSON.stringify(error))
    }
}

module.exports  = {
	login
}

